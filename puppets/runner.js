//@ts-check
const puppeteer = require("puppeteer")

module.exports = ({headless, instructions, url}) => {
  let runner = async (no_pictures = false) => {
    let state
    console.log("Waking up Puppets...")
    const webbrowser = await puppeteer.launch({ headless })
    const mobilebrowser = await puppeteer.launch({ headless })
    console.log("Running Puppets")
    const webpage = await webbrowser.newPage()
    const mobilepage = await mobilebrowser.newPage()
    if (no_pictures) {
      //@ts-ignore
      webpage.screenshot = async () => { }
      //@ts-ignore
      mobilepage.screenshot = async () => { }
    }
    const started = new Date()
    await webpage.goto(url)
    await mobilepage.goto(url)
    const web = instructions.web(webpage)
    const mobile = instructions.mobile(mobilepage)
    try {
      state = {
        started,
        finished: new Date(),
        web: await web,
        mobile: await mobile,
      }
    } catch (e) {
      console.log(e)
      state = {
        error: true,
        scope: e.scope,
        started,
        finished: new Date(),
        e: e.message,
      }
    }
    console.log({ state })
    await webbrowser.close()
    await mobilebrowser.close()
    return state
  }
  return runner
}